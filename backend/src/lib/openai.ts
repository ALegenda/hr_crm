import OpenAI from 'openai';
import dotenv from 'dotenv';

dotenv.config();

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

interface QuestionsResponse {
  questions: string[];
}

interface AnalysisResponse {
  summary: string;
  skills: {
    [key: string]: number;
  };
  fit: number;
  recommendation: string;
}

export async function generateQuestions(
  title: string,
  description: string,
  skills: string[],
  requirements: string,
  context: string
): Promise<string[]> {
  const prompt = `
    ВАЖНО: ВСЕ ВОПРОСЫ ДОЛЖНЫ БЫТЬ НА РУССКОМ ЯЗЫКЕ.
    
    Вы HR-специалист, создающий опросник для вакансии.
    
    Название должности: ${title}
    Описание должности: ${description}
    Необходимые навыки: ${skills.join(', ')}
    Требования: ${requirements}
    Контекст компании: ${context}
    
    Ценности компании:
    - Командная работа (команда быстрее достигает цели, чем коллектив профессионалов и экспертов)
    - Эффективность (используем ресурсы эффективно: фокусируемся на основных задачах, увеличиваем производительность каждого ресурса)
    - Приоритеты (отдаём приоритет тому, что НУЖНО и ВАЖНО)
    - Развитие (развитие компании зависит от развития каждого сотрудника. Изменения неизбежны)
    - Системность (ориентируемся на игру в долгую и любим системные процессы)
    - Прозрачность (Все процессы внутри компании прозрачны и доступны: принципы принятия решений, системы закупа и продаж, назначение на должность)
    - Конструктив (Обратная связь помогает увидеть новые возможности)
    - Достижение целей (Мы не достигаем показатели «любой ценой», не «читерим» и не используем методы, ведущие к достижению показателей путём искажения цели)
    - Опыт (Делиться негативным опытом полезно для общего развития)
    
    Создайте 6-7 релевантных вопросов для оценки кандидатов на эту должность по следующей структуре:
    
    1. 2-3 общих вопроса на выявление ценностей и принципов кандидата, связанных с ценностями компании
    2. 2 вопроса на выявление карьерных целей и мотивации
    3. 2 вопроса на выявление поведенческих особенностей кандидата, которые могут раскрыть личные качества и стиль/подход работы
    
    Примеры качественных вопросов:
    - «Можете привести пример ситуации, когда вы работали в команде и столкнулись с разногласиями внутри группы? Как вы подступились к разрешению конфликта и что вы из этого вынесли относительно ценности командной работы?»
    - «Опишите случай, когда вам пришлось расставить приоритеты в своей работе, чтобы достигнуть важной цели. Какие факторы вы учитывали при этом решении, и как это повлияло на общий результат?»
    - «Что вас вдохновляет и движет в работе? Какие факторы для вас наиболее важны при выборе места работы и в процессе выполнения задач?»
    - «Расскажите о ситуации, в которой вам пришлось работать в команде над сложным проектом. Какие трудности возникли, какова была ваша роль и к каким действиям вы прибегли для успешного завершения задачи?»
    
    ВСЕ ВОПРОСЫ ДОЛЖНЫ БЫТЬ ТОЛЬКО НА РУССКОМ ЯЗЫКЕ.
    
    Верните ТОЛЬКО массив вопросов в формате JSON: {"questions": ["Вопрос 1", "Вопрос 2", ...]}
  `;

  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: prompt }],
      response_format: { type: 'json_object' },
    });

    const content = response.choices[0].message.content;
    if (!content) {
      throw new Error('Empty response from OpenAI');
    }
    
    const parsedResponse = JSON.parse(content) as QuestionsResponse;
    return parsedResponse.questions;
  } catch (error) {
    console.error('Error generating questions with OpenAI:', error);
    // Fallback to default questions if OpenAI fails
    return [
      "Какой релевантный опыт вы имеете для этой позиции?",
      "Опишите сложный проект, над которым вы недавно работали.",
      "Как вы следите за последними тенденциями в отрасли?",
      "Каковы ваши главные профессиональные сильные стороны?",
      "Как вы справляетесь со сжатыми сроками и давлением?",
      "Опишите ваш подход к решению проблем.",
      "Каковы ваши карьерные цели на ближайшие 3-5 лет?",
      "Почему вас интересует эта должность?"
    ];
  }
}

export async function analyzeAnswers(
  jobTitle: string,
  jobDescription: string,
  skills: string[],
  requirements: string,
  qaList: { question: string; answer: string }[]
): Promise<AnalysisResponse> {
  const questionsAndAnswers = qaList
    .map((qa, i) => `Q${i + 1}: ${qa.question}\nA${i + 1}: ${qa.answer || 'No answer'}`)
    .join('\n\n');

  const prompt = `
    ВАЖНО: ВСЕ ОТВЕТЫ ДОЛЖНЫ БЫТЬ НА РУССКОМ ЯЗЫКЕ.
    
    Вы HR-специалист, анализирующий ответы кандидата на вопросы собеседования.
    
    Название должности: ${jobTitle}
    Описание должности: ${jobDescription}
    Необходимые навыки: ${skills.join(', ')}
    Требования к должности: ${requirements}
    
    Ценности компании:
    - Командная работа (команда быстрее достигает цели, чем коллектив профессионалов и экспертов)
    - Эффективность (используем ресурсы эффективно: фокусируемся на основных задачах, увеличиваем производительность каждого ресурса)
    - Приоритеты (отдаём приоритет тому, что НУЖНО и ВАЖНО)
    - Развитие (развитие компании зависит от развития каждого сотрудника. Изменения неизбежны)
    - Системность (ориентируемся на игру в долгую и любим системные процессы)
    - Прозрачность (Все процессы внутри компании прозрачны и доступны: принципы принятия решений, системы закупа и продаж, назначение на должность)
    - Конструктив (Обратная связь помогает увидеть новые возможности)
    - Достижение целей (Мы не достигаем показатели «любой ценой», не «читерим» и не используем методы, ведущие к достижению показателей путём искажения цели)
    - Опыт (Делиться негативным опытом полезно для общего развития)
    
    Вопросы и ответы:
    ${questionsAndAnswers}
    
    Проанализируйте ответы кандидата и предоставьте структурированную оценку.
    Особое внимание уделите:
    1. Соответствию ценностей кандидата ценностям компании
    2. Карьерным целям и мотивации
    3. Поведенческим особенностям и подходу к работе
    
    ВЕСЬ ОТВЕТ ДОЛЖЕН БЫТЬ ТОЛЬКО НА РУССКОМ ЯЗЫКЕ.
    
    Верните ТОЛЬКО JSON-объект следующего формата:
    {
      "summary": "Краткое резюме общего профиля кандидата",
      "skills": {
        "навык1": оценка (1-10),
        "навык2": оценка (1-10),
        ...
      },
      "fit": общая оценка соответствия (1-10),
      "recommendation": "Нанять/Рассмотреть/Отклонить с кратким обоснованием"
    }
  `;

  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: prompt }],
      response_format: { type: 'json_object' },
    });

    const content = response.choices[0].message.content;
    if (!content) {
      throw new Error('Empty response from OpenAI');
    }
    
    return JSON.parse(content) as AnalysisResponse;
  } catch (error) {
    console.error('Error analyzing answers with OpenAI:', error);
    // Fallback to basic analysis if OpenAI fails
    return {
      summary: "Не удалось сгенерировать AI-анализ. Требуется ручная проверка.",
      skills: skills.reduce((acc, skill) => ({ ...acc, [skill]: 5 }), {}),
      fit: 5,
      recommendation: "Рассмотреть - AI-анализ недоступен, пожалуйста, проверьте вручную"
    };
  }
}

export default openai; 